# RBAC权限系统 - 互动式示例

## 🎯 4个人物的完整故事

让我们一起跟踪4个用户在系统中的完整权限体验：

### 📋 人物卡片

#### 👨‍💼 **admin - 超级管理员**
```
🆔 ID: 1
👤 昵称: 超级管理员
🏢 部门: 研发部门 (103)
🎭 角色: 超级管理员 (1)
🔑 权限: 全部功能 + 全部数据
🎯 数据范围: 全部数据权限 (data_scope=1)
```

#### 🧑‍💻 **nianago - 普通员工**
```
🆔 ID: 2
👤 昵称: 年糕
🏢 部门: 测试部门 (105)
🎭 角色: 普通角色 (2)
🔑 权限: 基础查看功能
🎯 数据范围: 自定义权限 (data_scope=2)
```

#### 👨‍🔧 **张三 - 研发主管**
```
🆔 ID: 3
👤 昵称: 张三
🏢 部门: 研发部门 (103)
🎭 角色: 研发主管 (3)
🔑 权限: 部门管理功能
🎯 数据范围: 自定义权限 (data_scope=2)
```

#### 👩‍🔬 **李四 - 测试主管**
```
🆔 ID: 4
👤 昵称: 李四
🏢 部门: 测试部门 (105)
🎭 角色: 测试主管 (4)
🔑 权限: 部门管理功能
🎯 数据范围: 本部门权限 (data_scope=3)
```

## 🎬 场景演示

### 🌅 场景1：早晨上班登录

#### admin登录后的界面
```
🖥️ 系统管理
├── 👁️ 用户管理 ✅
│   ├── ➕ 新增用户 ✅
│   ├── ✏️ 修改用户 ✅
│   └── 🗑️ 删除用户 ✅
├── 👁️ 角色管理 ✅
├── 👁️ 菜单管理 ✅
├── 👁️ 部门管理 ✅
├── 👁️ 岗位管理 ✅
└── 👁️ 字典管理 ✅

📊 用户列表 (共4人)
┌───┬─────────┬─────────┬─────────────┐
│ID │ 用户名   │ 部门     │ 状态        │
├───┼─────────┼─────────┼─────────────┤
│1  │ admin    │ 研发部门 │ 正常        │
│2  │ nianago  │ 测试部门 │ 正常        │
│3  │ 张三     │ 研发部门 │ 正常        │
│4  │ 李四     │ 测试部门 │ 正常        │
└───┴─────────┴─────────┴─────────────┘
```

#### 张三登录后的界面
```
🖥️ 系统管理
├── ❌ 用户管理 (无权限)
├── ❌ 角色管理 (无权限)
├── ❌ 菜单管理 (无权限)
├── 👁️ 部门管理 ✅
└── ❌ 其他功能 (无权限)

📊 用户列表 (共4人 - 研发+测试部门)
┌───┬─────────┬─────────┬─────────────┐
│ID │ 用户名   │ 部门     │ 备注        │
├───┼─────────┼─────────┼─────────────┤
│1  │ admin    │ 研发部门 │ (可管理)    │
│3  │ 张三     │ 研发部门 │ (自己)      │
│2  │ nianago  │ 测试部门 │ (可管理)    │
│4  │ 李四     │ 测试部门 │ (可管理)    │
└───┴─────────┴─────────┴─────────────┘
```

#### 李四登录后的界面
```
🖥️ 系统管理
├── ❌ 用户管理 (无权限)
├── ❌ 角色管理 (无权限)
├── ❌ 菜单管理 (无权限)
├── 👁️ 部门管理 ✅
└── ❌ 其他功能 (无权限)

📊 用户列表 (共2人 - 仅测试部门)
┌───┬─────────┬─────────┬─────────────┐
│ID │ 用户名   │ 部门     │ 备注        │
├───┼─────────┼─────────┼─────────────┤
│2  │ nianago  │ 测试部门 │ (可管理)    │
│4  │ 李四     │ 测试部门 │ (自己)      │
└───┴─────────┴─────────┴─────────────┘
```

#### nianago登录后的界面
```
🖥️ 系统管理
├── 👁️ 用户管理 ✅ (只读)
│   ├── ➕ 新增用户 ❌ (无权限)
│   ├── ✏️ 修改用户 ❌ (无权限)
│   └── 🗑️ 删除用户 ❌ (无权限)
├── ❌ 其他功能 (无权限)

📊 用户列表 (共1人 - 仅自己部门)
┌───┬─────────┬─────────┬─────────────┐
│ID │ 用户名   │ 部门     │ 备注        │
├───┼─────────┼─────────┼─────────────┤
│2  │ nianago  │ 测试部门 │ (自己)      │
└───┴─────────┴─────────┴─────────────┘
```

## 🔍 权限验证过程

### 让我们跟踪"张三想新增用户"的完整过程：

```mermaid
flowchart TD
    A[张三点击新增用户] --> B{系统检查权限}
    B -->|查询用户角色| C[sys_user_role: user_id=3 → role_id=3]
    C --> D[sys_role: role_id=3 → 研发主管]
    D --> E{检查菜单权限}
    E -->|查询role_menu| F[sys_role_menu: role_id=3, menu_id=?]
    F --> G[找到: menu_id=103(部门管理)]
    G --> H{检查具体权限}
    H -->|检查菜单详情| I[sys_menu: menu_id=100(用户管理)]
    I --> J{role_id=3能访问menu_id=100吗?}
    J -->|否| K[❌ 权限不足]
    K --> L[显示: 无权限访问]

    style A fill:#e1f5fe
    style K fill:#ffebee
    style L fill:#ffcdd2
```

**SQL查询过程：**
```sql
-- 步骤1: 获取张三的角色
SELECT role_id FROM sys_user_role WHERE user_id = 3;
-- 结果: 3 (研发主管)

-- 步骤2: 检查研发主管是否有用户管理权限
SELECT COUNT(*) FROM sys_role_menu
WHERE role_id = 3 AND menu_id = 100;
-- 结果: 0 (没有权限)

-- 结论: 张三不能访问用户管理功能
```

## 🎯 实际业务操作对比

### 操作1：新增用户

| 操作者 | 能否新增 | 理由 | 看到的界面 |
|--------|----------|------|------------|
| admin | ✅ 可以 | 超级管理员有全部权限 | 完整的新增表单 |
| nianago | ❌ 不行 | 普通角色没有新增权限 | 新增按钮灰色 |
| 张三 | ❌ 不行 | 研发主管没有用户管理权限 | 看不到用户管理 |
| 李四 | ❌ 不行 | 测试主管没有用户管理权限 | 看不到用户管理 |

### 操作2：查看用户列表

| 操作者 | 看到人数 | 数据范围 | 权限说明 |
|--------|----------|----------|----------|
| admin | 4人 | 全部部门 | 超级管理员全部数据 |
| nianago | 1人 | 自己部门 | 普通角色基础数据 |
| 张三 | 4人 | 研发+测试 | 研发主管自定义权限 |
| 李四 | 2人 | 测试部门 | 测试主管本部门权限 |

### 操作3：管理部门信息

| 操作者 | 能否管理 | 管理范围 | 具体操作 |
|--------|----------|----------|----------|
| admin | ✅ 可以 | 所有部门 | 可以修改任何部门信息 |
| nianago | ❌ 不行 | 无权限 | 看不到部门管理 |
| 张三 | ✅ 可以 | 研发+测试 | 可以修改研发和测试部门 |
| 李四 | ✅ 可以 | 测试部门 | 只能修改测试部门 |

## 🔐 权限规则速查

### 数据权限规则表

| data_scope | 含义 | 示例说明 |
|------------|------|----------|
| 1 | 全部数据权限 | admin能看所有部门所有数据 |
| 2 | 自定义数据权限 | 张三能看sys_role_dept中指定的部门 |
| 3 | 本部门数据权限 | 李四只能看测试部门数据 |
| 4 | 本部门及以下 | 如果配置，能看到下属部门数据 |

### 功能权限规则

| 权限类型 | 判断方式 | 示例 |
|----------|----------|------|
| 菜单权限 | sys_role_menu关联 | 角色有菜单ID就能看到功能 |
| 按钮权限 | sys_menu.perms字段 | 具体到system:user:add这样的权限 |
| 数据权限 | sys_role_dept + data_scope | 控制能看到哪些数据 |

## 🎪 互动问答

### ❓ 问题1：为什么张三能看到李四的数据？
**答：** 因为张三是研发主管，通过sys_role_dept配置可以管理研发部门(103)和测试部门(105)的数据，而李四在测试部门，所以张三能看到李四的信息。

### ❓ 问题2：为什么nianago只能看到1个用户？
**答：** nianago是普通角色，data_scope=2(自定义权限)但没有在sys_role_dept中配置具体部门，所以系统默认只显示自己部门的用户数据。

### ❓ 问题3：如果给李四增加"用户管理"权限会怎样？
**答：** 李四会看到用户管理菜单，但因为data_scope=3(本部门权限)，只能看到测试部门的用户，不能新增或修改其他部门的用户。

### ❓ 问题4：一个用户可以有多个角色吗？
**答：** 可以！比如张三既可以是研发主管，也可以是普通角色，这样他会同时拥有两个角色的权限，权限会叠加。

## 🎉 总结

通过这4个具体人物的示例，我们可以看到RBAC权限系统的精髓：

1. **🎭 角色分离**：权限不直接给用户，而是给角色
2. **🔐 权限分层**：功能权限和数据权限分开控制
3. **🎯 精细控制**：可以精确到按钮级别和具体数据
4. **🔄 灵活配置**：通过中间表灵活调整权限关系

这种设计既保证了系统的安全性，又提供了足够的灵活性来适配各种复杂的业务场景！